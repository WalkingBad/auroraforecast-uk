---
/**
 * City Search Component
 * Reusable search box for finding aurora viewing cities
 */
import citiesData from '../data/site-cities';
import '../styles/components/city-search.css';
import type { I18nPageHelper } from '../utils/i18n-page';

export interface Props {
  i18n?: I18nPageHelper;
  placeholder?: string;
  id?: string;
  compact?: boolean;
}

const { i18n, placeholder, id = 'city-search', compact = false } = Astro.props;

const searchPlaceholder = placeholder
  || (i18n ? i18n.t('live_bar_search_placeholder') : 'Search cities...');

// Pass city metadata to client-side for rendering (include lat/lon for geolocation)
const cityMetadata = citiesData.map(city => ({
  name: city.name,
  slug: city.slug,
  country: city.country,
  countryCode: city.countryCode,
  state: city.stateName || city.state,
  magneticLat: city.magneticLat,
  lat: city.lat,
  lon: city.lon
}));

const geoButtonId = `${id}-geo-btn`;

const inputId = `${id}-input`;
const resultsId = `${id}-results`;
---

<div class:list={["city-search", { compact }]}>
  <button
    type="button"
    id={geoButtonId}
    class="geo-button"
    title="Find nearest city"
    aria-label="Find nearest aurora viewing location"
  >
    <svg viewBox="0 0 24 24" aria-hidden="true">
      <path fill="currentColor" d="M12 8c-2.21 0-4 1.79-4 4s1.79 4 4 4 4-1.79 4-4-1.79-4-4-4zm8.94 3A8.994 8.994 0 0 0 13 3.06V1h-2v2.06A8.994 8.994 0 0 0 3.06 11H1v2h2.06A8.994 8.994 0 0 0 11 20.94V23h2v-2.06A8.994 8.994 0 0 0 20.94 13H23v-2h-2.06zM12 19c-3.87 0-7-3.13-7-7s3.13-7 7-7 7 3.13 7 7-3.13 7-7 7z"/>
    </svg>
  </button>
  <div class="search-wrapper">
    <svg class="search-icon" viewBox="0 0 24 24" aria-hidden="true">
      <path fill="currentColor" d="M15.5 14h-.79l-.28-.27A6.471 6.471 0 0 0 16 9.5 6.5 6.5 0 1 0 9.5 16c1.61 0 3.09-.59 4.23-1.57l.27.28v.79l5 4.99L20.49 19l-4.99-5zm-6 0C7.01 14 5 11.99 5 9.5S7.01 5 9.5 5 14 7.01 14 9.5 11.99 14 9.5 14z"/>
    </svg>
    <input
      type="text"
      placeholder={searchPlaceholder}
      id={inputId}
      class="search-input"
      autocomplete="off"
    />
    <div id={resultsId} class="search-results hidden"></div>
  </div>
</div>

<!-- Template for search results -->
<template id={`${id}-result-template`}>
  <a href="" class="search-result-item">
    <div class="result-main">
      <span class="result-name"></span>
      <span class="result-location"></span>
    </div>
    <span class="result-status">●</span>
  </a>
</template>

<template id={`${id}-no-results-template`}>
  <div class="no-results"></div>
</template>

<script define:vars={{ cityMetadata, inputId, resultsId, id, geoButtonId }}>
  // Export city metadata for search
  if (!window.AURORA_CITY_METADATA) {
    window.AURORA_CITY_METADATA = cityMetadata;
  }

  // Initialize search for this instance
  (function() {
    const searchInput = document.getElementById(inputId);
    const searchResults = document.getElementById(resultsId);
    const resultTemplate = document.getElementById(`${id}-result-template`);
    const noResultsTemplate = document.getElementById(`${id}-no-results-template`);
    const geoButton = document.getElementById(geoButtonId);

    if (!searchInput || !searchResults || !resultTemplate) return;

    // Haversine formula to calculate distance between two points
    const haversineDistance = (lat1, lon1, lat2, lon2) => {
      const R = 6371; // Earth's radius in km
      const dLat = (lat2 - lat1) * Math.PI / 180;
      const dLon = (lon2 - lon1) * Math.PI / 180;
      const a = Math.sin(dLat / 2) * Math.sin(dLat / 2) +
                Math.cos(lat1 * Math.PI / 180) * Math.cos(lat2 * Math.PI / 180) *
                Math.sin(dLon / 2) * Math.sin(dLon / 2);
      const c = 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1 - a));
      return R * c;
    };

    // Find nearest city from user's location
    const findNearestCity = (userLat, userLon) => {
      let nearestCity = null;
      let minDistance = Infinity;

      for (const city of cityMetadata) {
        if (city.lat && city.lon) {
          const distance = haversineDistance(userLat, userLon, city.lat, city.lon);
          if (distance < minDistance) {
            minDistance = distance;
            nearestCity = city;
          }
        }
      }

      return { city: nearestCity, distance: minDistance };
    };

    // Geolocation button handler
    if (geoButton) {
      geoButton.addEventListener('click', () => {
        if (!navigator.geolocation) {
          alert('Geolocation is not supported by your browser');
          return;
        }

        geoButton.classList.add('loading');

        navigator.geolocation.getCurrentPosition(
          (position) => {
            const { latitude, longitude } = position.coords;
            const result = findNearestCity(latitude, longitude);

            geoButton.classList.remove('loading');

            if (result.city) {
              window.location.href = `/${result.city.slug}`;
            } else {
              alert('No aurora viewing locations found nearby');
            }
          },
          (error) => {
            geoButton.classList.remove('loading');
            let message = 'Unable to get your location';
            if (error.code === error.PERMISSION_DENIED) {
              message = 'Location access denied. Please enable location services.';
            }
            alert(message);
          },
          { enableHighAccuracy: false, timeout: 10000, maximumAge: 300000 }
        );
      });
    }

    // Normalize search text for special characters and multiple languages
    const normalizeSearchText = (text) => {
      return text
        .toLowerCase()
        .normalize('NFD')
        .replace(/[\u0300-\u036f]/g, '')
        .replace(/ø/g, 'o')
        .replace(/ö/g, 'o')
        .replace(/å/g, 'a')
        .replace(/ä/g, 'a')
        .replace(/æ/g, 'ae')
        .replace(/ü/g, 'u')
        .replace(/ñ/g, 'n')
        .replace(/ç/g, 'c')
        .replace(/ß/g, 'ss')
        .replace(/þ/g, 'th')
        .replace(/ð/g, 'd');
    };

    const renderNoResults = (message) => {
      searchResults.replaceChildren();
      const clone = noResultsTemplate.content.cloneNode(true);
      clone.querySelector('.no-results').textContent = message;
      searchResults.appendChild(clone);
      searchResults.classList.remove('hidden');
    };

    const renderResults = (matches) => {
      searchResults.replaceChildren();
      matches.forEach(city => {
        const clone = resultTemplate.content.cloneNode(true);
        const link = clone.querySelector('a');
        link.href = city.url;
        clone.querySelector('.result-name').textContent = city.name;
        clone.querySelector('.result-location').textContent =
          city.country + (city.state ? `, ${city.state}` : '');
        const status = clone.querySelector('.result-status');
        status.style.color = city.color;
        searchResults.appendChild(clone);
      });
      searchResults.classList.remove('hidden');
    };

    let debounceTimer;

    searchInput.addEventListener('input', (e) => {
      clearTimeout(debounceTimer);

      debounceTimer = setTimeout(() => {
        const query = normalizeSearchText(e.target.value.trim());

        if (query.length < 2) {
          searchResults.classList.add('hidden');
          return;
        }

        // Use global index if available
        const index = window.AURORA_SEARCH_INDEX || [];

        if (index.length === 0) {
          renderNoResults('Loading data...');
          return;
        }

        // Filter cities
        const matches = index
          .filter(city => city.searchText.includes(query))
          .slice(0, 8);

        if (matches.length === 0) {
          renderNoResults('No cities found');
          return;
        }

        renderResults(matches);
      }, 200);
    });

    // Close search results when clicking outside
    document.addEventListener('click', (e) => {
      if (!searchInput.contains(e.target) && !searchResults.contains(e.target)) {
        searchResults.classList.add('hidden');
      }
    });

    // Show results when focusing input
    searchInput.addEventListener('focus', () => {
      const index = window.AURORA_SEARCH_INDEX || [];
      if (searchInput.value.length >= 2 && index.length > 0) {
        searchResults.classList.remove('hidden');
      }
    });
  })();
</script>
