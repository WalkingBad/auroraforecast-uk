---
import BaseLayout from '../../layouts/BaseLayout.astro';
import '../../styles/components/checkout-success.css';

const apiBase = import.meta.env.PUBLIC_API_BASE_URL || 'https://europe-west1-aurorame-621f6.cloudfunctions.net';
---

<BaseLayout
  title="Activate Your Premium Access | AuroraMe"
  description="Activating your premium aurora forecast access"
  canonical="https://auroraforecast.uk/checkout/success"
>
  <main class="checkout-success-page">
    <div class="success-container">
      <div class="success-icon">âœ…</div>
      <h1>Payment Successful!</h1>

      <!-- Auto-activation UI (shown when order_id present) -->
      <div id="auto-activation" style="display: none;">
        <p class="success-subtitle" id="status-text">Activating your access...</p>
        <div id="loading-spinner" class="loading-spinner"></div>
        <div id="error-container" style="display: none;">
          <div id="error-message" class="error-message"></div>
          <button id="retry-btn" class="submit-button" style="margin-top: 16px;">Retry</button>
        </div>
      </div>

      <!-- Manual email form (fallback) -->
      <div id="manual-form">
        <p class="success-subtitle">Enter the email you used at checkout to activate your premium access</p>
        <form id="claim-form" class="claim-form">
          <div class="form-group">
            <label for="email">Email Address</label>
            <input
              type="email"
              id="email"
              name="email"
              placeholder="your@email.com"
              required
              autocomplete="email"
            />
          </div>

          <button type="submit" id="submit-btn" class="submit-button">
            <span class="btn-text">Activate Access</span>
            <span class="btn-loading" style="display: none;">Activating...</span>
          </button>

          <div id="form-error-message" class="error-message" style="display: none;"></div>
          <div id="form-success-message" class="success-message" style="display: none;"></div>
        </form>

        <div class="help-text">
          <p>Didn't receive a confirmation email? Check your spam folder or contact support.</p>
        </div>
      </div>
    </div>
  </main>
</BaseLayout>

<style>
  .loading-spinner {
    width: 40px;
    height: 40px;
    border: 4px solid rgba(255, 255, 255, 0.2);
    border-top-color: #34C97B;
    border-radius: 50%;
    animation: spin 1s linear infinite;
    margin: 20px auto;
  }

  @keyframes spin {
    to { transform: rotate(360deg); }
  }
</style>

<script define:vars={{ apiBase }}>
  // Parse URL params client-side
  const urlParams = new URLSearchParams(window.location.search);
  const orderId = urlParams.get('order_id');
  const redirectUrl = urlParams.get('redirect') || '/';
  const citySlug = urlParams.get('city') || '';

  // Check if we have a valid order_id
  const hasOrderId = orderId && orderId !== '{order_id}' && orderId !== '[order_id]';

  // Determine order_id status for debugging
  const orderIdStatus = !orderId ? 'missing'
    : orderId.includes('{') || orderId.includes('[') ? 'template_not_replaced'
    : 'valid';

  // Track page view with detailed context
  if (typeof gtag !== 'undefined') {
    gtag('event', 'checkout_success_viewed', {
      city: citySlug,
      redirect_url: redirectUrl,
      has_order_id: hasOrderId,
      order_id_status: orderIdStatus,
    });
  }

  const autoActivationDiv = document.getElementById('auto-activation');
  const manualFormDiv = document.getElementById('manual-form');

  if (hasOrderId) {
    // Show auto-activation UI, hide form
    autoActivationDiv.style.display = 'block';
    manualFormDiv.style.display = 'none';

    const statusText = document.getElementById('status-text');
    const spinner = document.getElementById('loading-spinner');
    const errorContainer = document.getElementById('error-container');
    const errorMessage = document.getElementById('error-message');
    const retryBtn = document.getElementById('retry-btn');

    async function activateByOrder() {
      statusText.textContent = 'Activating your access...';
      spinner.style.display = 'block';
      errorContainer.style.display = 'none';

      try {
        const response = await fetch(`${apiBase}/claimPremiumByOrder`, {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json',
          },
          credentials: 'include',
          body: JSON.stringify({ orderId }),
        });

        const data = await response.json();

        if (response.ok && data.premium) {
          // Set client-side flag cookie for JS access check (30 days for extended product)
          document.cookie = `aurora_premium_flag=active; path=/; max-age=${30 * 24 * 60 * 60}; SameSite=Lax`;

          // Save token to localStorage as fallback for blocked 3rd-party cookies
          if (data.token) {
            try {
              localStorage.setItem('aurora_premium_token', data.token);
              localStorage.setItem('aurora_premium_expires', data.expiresAt);
            } catch (e) {
              console.warn('Could not save token to localStorage:', e);
            }
          }

          // Track GA4 event
          if (typeof gtag !== 'undefined') {
            gtag('event', 'premium_activated', {
              method: 'order_id_auto',
              city: citySlug,
              expires_at: data.expiresAt,
            });
          }

          statusText.textContent = 'Access activated! Redirecting...';
          spinner.style.display = 'none';

          // Redirect to city page with anchor to forecast block
          let finalRedirect = data.redirectUrl || redirectUrl || '/';
          // Add anchor to scroll to premium forecast if it's a city page
          if (finalRedirect !== '/' && !finalRedirect.includes('#')) {
            finalRedirect += '#premium-forecast';
          }
          setTimeout(() => {
            window.location.href = finalRedirect;
          }, 1500);
        } else {
          throw new Error(data.error || 'Activation failed');
        }
      } catch (error) {
        console.error('Auto-activation error:', error);
        spinner.style.display = 'none';
        errorMessage.textContent = error.message || 'Failed to activate. Please try again.';
        errorContainer.style.display = 'block';
        statusText.textContent = 'Activation failed';

        // Track activation failure in GA4
        if (typeof gtag !== 'undefined') {
          gtag('event', 'premium_activation_failed', {
            method: 'order_id_auto',
            city: citySlug,
            error_message: error.message || 'unknown',
            order_id: orderId,
          });
        }
      }
    }

    // Start auto-activation
    activateByOrder();

    // Retry button
    retryBtn?.addEventListener('click', activateByOrder);

  } else {
    // Keep manual form visible (default)
    // Manual email form
    const form = document.getElementById('claim-form');
    const emailInput = document.getElementById('email');
    const submitBtn = document.getElementById('submit-btn');
    const btnText = submitBtn?.querySelector('.btn-text');
    const btnLoading = submitBtn?.querySelector('.btn-loading');
    const errorMsg = document.getElementById('form-error-message');
    const successMsg = document.getElementById('form-success-message');

    form?.addEventListener('submit', async (e) => {
      e.preventDefault();

      const email = emailInput.value.trim().toLowerCase();
      if (!email) return;

      // Show loading state
      btnText.style.display = 'none';
      btnLoading.style.display = 'inline';
      submitBtn.disabled = true;
      errorMsg.style.display = 'none';
      successMsg.style.display = 'none';

      try {
        const response = await fetch(`${apiBase}/claimPremiumAccess`, {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json',
          },
          credentials: 'include',
          body: JSON.stringify({ email }),
        });

        const data = await response.json();

        if (response.ok && data.premium) {
          // Set client-side flag cookie (30 days for extended product)
          document.cookie = `aurora_premium_flag=active; path=/; max-age=${30 * 24 * 60 * 60}; SameSite=Lax`;

          // Save token to localStorage as fallback for blocked 3rd-party cookies
          if (data.token) {
            try {
              localStorage.setItem('aurora_premium_token', data.token);
              localStorage.setItem('aurora_premium_expires', data.expiresAt);
            } catch (e) {
              console.warn('Could not save token to localStorage:', e);
            }
          }

          // Track GA4 event
          if (typeof gtag !== 'undefined') {
            gtag('event', 'premium_activated', {
              method: 'email_claim',
              city: citySlug,
              expires_at: data.expiresAt,
            });
          }

          successMsg.textContent = 'Access activated! Redirecting...';
          successMsg.style.display = 'block';

          // Redirect with anchor to forecast block
          let finalRedirect = data.redirectUrl || redirectUrl || '/';
          if (finalRedirect !== '/' && !finalRedirect.includes('#')) {
            finalRedirect += '#premium-forecast';
          }
          setTimeout(() => {
            window.location.href = finalRedirect;
          }, 1500);
        } else {
          errorMsg.textContent = data.error || 'No active premium access found for this email.';
          errorMsg.style.display = 'block';
          btnText.style.display = 'inline';
          btnLoading.style.display = 'none';
          submitBtn.disabled = false;

          // Track email claim failure
          if (typeof gtag !== 'undefined') {
            gtag('event', 'premium_activation_failed', {
              method: 'email_claim',
              city: citySlug,
              error_message: data.error || 'no_access_found',
            });
          }
        }
      } catch (error) {
        console.error('Claim error:', error);
        errorMsg.textContent = 'Network error. Please try again.';
        errorMsg.style.display = 'block';
        btnText.style.display = 'inline';
        btnLoading.style.display = 'none';
        submitBtn.disabled = false;

        // Track network error
        if (typeof gtag !== 'undefined') {
          gtag('event', 'premium_activation_failed', {
            method: 'email_claim',
            city: citySlug,
            error_message: 'network_error',
          });
        }
      }
    });
  }
</script>
