---
import BaseLayout from '../layouts/BaseLayout.astro';
import '../styles/pages/aurora-tracker.css';
import '../styles/components/city-cards.css';
import '../styles/components/store-badges.css';
import StoreBadges from '../components/StoreBadges.astro';
import FAQ from '../components/FAQ.astro';
import EnhancedMobileAppCTA from '../components/EnhancedMobileAppCTA.astro';
import { loadGlobalCityStatuses, getCityStatus } from '../utils/global-status';
import { calculateKpThreshold } from '../utils/kp-bands';
import { generateTrackerTitle } from '../utils/seo-titles';
import { createPageI18n } from '../utils/i18n-page.ts';
import LiveForecastBar from '../components/LiveForecastBar.astro';
import citiesData from '../data/site-cities';

// Enable static generation
export const prerender = true;

// Initialize i18n
const i18n = await createPageI18n('en');

// Build-time: Load all city statuses
const globalCityStatuses = await loadGlobalCityStatuses();

// Debug: Check if statuses loaded
const statusCount = Object.keys(globalCityStatuses).length;
console.log(`[Aurora Tracker] Loaded ${statusCount} city statuses`);

// Get all cities from database and enrich with status
const allCitiesWithStatus = citiesData.map(city => ({
  ...city,
  kpThreshold: calculateKpThreshold(city.magneticLat),
  status: getCityStatus(city.slug)
}));

const citySearchIndex = allCitiesWithStatus.map(city => {
  const status = city.status ?? {
    status: 'unknown',
    statusText: 'Check forecast',
    color: '#666666'
  };

  const kpThresholdValue = calculateKpThreshold(city.magneticLat);
  const kpThreshold = Number.isFinite(kpThresholdValue)
    ? Number(kpThresholdValue.toFixed(1))
    : null;

  const magneticLat = Number.isFinite(city.magneticLat)
    ? Number(city.magneticLat)
    : null;

  return {
    slug: city.slug,
    name: city.name,
    country: city.country,
    countryCode: city.countryCode ?? '',
    magneticLat,
    kpThreshold,
    status: {
      level: status.status,
      text: status.statusText,
      color: status.color
    }
  };
});

// Debug: Count status distribution
const debugStatuses = allCitiesWithStatus.reduce((acc, c) => {
  acc[c.status.status] = (acc[c.status.status] || 0) + 1;
  return acc;
}, {} as Record<string, number>);
console.log('[Aurora Tracker] Status distribution:', debugStatuses);

// Filter cities where aurora is visible NOW (status != 'very_low')
// Note: API returns 'very_low' with underscore, not 'very-low' with dash
// If API failed, statusCount will be 0 and all cities have status 'unknown'
const apiAvailable = statusCount > 0;
const visibleNowCities = apiAvailable
  ? allCitiesWithStatus.filter(c => c.status.status !== 'very_low' && c.status.status !== 'unknown')
  : []; // Show empty if API unavailable

// Sort by status priority (high > medium > low) and MLAT
const statusPriority: Record<string, number> = { 'high': 3, 'medium': 2, 'low': 1, 'very_low': 0, 'unknown': 0 };
visibleNowCities.sort((a, b) => {
  const priorityDiff = (statusPriority[b.status.status] || 0) - (statusPriority[a.status.status] || 0);
  if (priorityDiff !== 0) return priorityDiff;
  return b.magneticLat - a.magneticLat; // Higher MLAT first
});

// Calculate current KP estimate from ALL cities (not just top 12)
const statusCounts = allCitiesWithStatus.reduce((acc, city) => {
  const status = city.status.status;
  acc[status] = (acc[status] || 0) + 1;
  return acc;
}, {} as Record<string, number>);

const totalCities = allCitiesWithStatus.filter(c => c.status.status !== 'unknown').length;

// KP estimation based on percentage of cities with high/medium status
let estimatedKP = 2.0;
const highPercentage = (statusCounts.high || 0) / totalCities;
const mediumPercentage = (statusCounts.medium || 0) / totalCities;

if (highPercentage >= 0.3) estimatedKP = 6.0;
else if (highPercentage >= 0.15) estimatedKP = 5.0;
else if (highPercentage >= 0.05 || mediumPercentage >= 0.3) estimatedKP = 4.0;
else if (mediumPercentage >= 0.15) estimatedKP = 3.5;
else if (mediumPercentage >= 0.05) estimatedKP = 3.0;

// KP color based on value
const getKpColor = (kp: number) => {
  if (kp >= 6) return 'var(--aurora-status-high)';
  if (kp >= 4) return 'var(--aurora-status-medium)';
  if (kp >= 2) return 'var(--aurora-status-low)';
  return 'var(--aurora-text-tertiary)';
};

const kpLabel = estimatedKP >= 6 ? i18n.t('tracker_kp_strong') :
                estimatedKP >= 4 ? i18n.t('tracker_kp_moderate') :
                estimatedKP >= 2 ? i18n.t('tracker_kp_weak') :
                i18n.t('tracker_kp_very_weak');

const kpColor = getKpColor(estimatedKP);

// Count ALL visible cities (not just top 12)
const visibleCitiesCount = visibleNowCities.length;

const pageTitle = i18n.t('tracker_meta_title');
const pageDescription = i18n.t('tracker_meta_description')
  .replace('{totalCities}', totalCities.toString())
  .replace('{estimatedKP}', estimatedKP.toFixed(1))
  .replace('{kpLabel}', kpLabel.toLowerCase());
const canonicalUrl = "https://auroraforecast.uk/aurora-tracker";
---

<BaseLayout
  title={pageTitle}
  description={pageDescription}
  canonical={canonicalUrl}
>
  <main>
    <!-- Live Forecast Bar (Search + Global Status) -->
    <LiveForecastBar />

    <!-- Static Map Section -->
    <section class="map-section">
      <div class="container">
        <h2>{generateTrackerTitle()}</h2>
        <div class="map-container">
           <img 
             src="https://services.swpc.noaa.gov/images/aurora-forecast-northern-hemisphere.jpg" 
             alt="Live Aurora Borealis Forecast Map (NOAA Ovation)" 
             width="800" 
             height="800" 
             loading="lazy"
             class="noaa-map"
           />
           <p class="map-credit">Source: NOAA Space Weather Prediction Center. Updated every 30 minutes.</p>
        </div>
      </div>
    </section>



    <!-- Live City Cards Dashboard -->
    <section class="country-cities-gallery">
      <div class="container-wide">
        <h2>{i18n.t('tracker_gallery_title')}</h2>
        <p class="gallery-subtitle">
          {visibleCitiesCount > 0
            ? i18n.t('tracker_gallery_subtitle_visible').replace('{count}', visibleCitiesCount.toString())
            : i18n.t('tracker_gallery_subtitle_empty')}
        </p>

        {visibleCitiesCount > 0 && (
          <div class="cities-grid-tracker">
            {visibleNowCities.map((city) => (
              <a href={`/${city.slug}`} class={`city-card status-${city.status.status}`}>
                <div class="city-card-content">
                  <div class="city-header">
                    <h3>{city.name}</h3>
                    <div class="city-meta">
                      <span class="meta-item">
                        <span class="meta-label">MLAT</span>
                        <span class="meta-value">{city.magneticLat.toFixed(1)}°</span>
                      </span>
                      <span class="meta-item">
                        <span class="meta-label">Min Kp</span>
                        <span class="meta-value">{city.kpThreshold.toFixed(1)}+</span>
                      </span>
                    </div>
                  </div>
                  <p class="city-description">{city.country}</p>

                  <div class="city-status-info">
                    <div class="city-status-text-group">
                      <div class="city-status-text">{i18n.t('tracker_city_status_label')}</div>
                      <div class="city-status-label">{city.status.statusText}</div>
                    </div>
                    <div class="city-view-btn">{i18n.t('tracker_city_view_forecast')}</div>
                  </div>
                </div>
              </a>
            ))}
          </div>
        )}
      </div>
    </section>

    <!-- What is KP -->
    <section class="kp-explanation">
      <div class="container">
        <h2>{i18n.t('tracker_kp_what_title')}</h2>
        <p>
          {i18n.t('tracker_kp_what_description')}
        </p>
        <div class="kp-scale">
          <div class="kp-range kp-low">
            <strong set:html={i18n.t('tracker_kp_range_0_2')}></strong>
          </div>
          <div class="kp-range kp-moderate">
            <strong set:html={i18n.t('tracker_kp_range_3_5')}></strong>
          </div>
          <div class="kp-range kp-strong">
            <strong set:html={i18n.t('tracker_kp_range_6_7')}></strong>
          </div>
          <div class="kp-range kp-extreme">
            <strong set:html={i18n.t('tracker_kp_range_8_9')}></strong>
          </div>
        </div>
        <p class="kp-disclaimer" set:html={i18n.t('tracker_kp_disclaimer')}></p>
      </div>
    </section>

    <!-- Enhanced Mobile App CTA (City Page Style) -->
    <EnhancedMobileAppCTA
      pageType="aurora_tracker"
      placement="timeline"
      context="timeline"
      showSocialProof={false}
    >
      <div slot="features-list" class="app-features-list">
         <!-- Reusing features list style from city page -->
         <ul class="features-grid">
           <li>Real-time KP & Weather</li>
           <li>Push Alerts</li>
           <li>Live Aurora Map</li>
           <li>Cloud Cover Forecast</li>
         </ul>
      </div>
      <StoreBadges
        slot="store-badges"
        pageType="aurora_tracker"
        placement="timeline_slot"
        enhanced={true}
        size="large"
      />
    </EnhancedMobileAppCTA>

    <!-- FAQ -->
    <div style="max-width: 1200px; margin: 0 auto; padding: 0 var(--aurora-spacing-l, 16px);">
      <FAQ />
    </div>

    <!-- Footer CTA -->
    <StoreBadges pageType="aurora_tracker" placement="sticky_footer" sticky={true} enhanced={true} />
  </main>
</BaseLayout>

<!-- Client-side city search -->


<!-- FAQ Schema -->
<script type="application/ld+json" set:html={JSON.stringify({
  "@context": "https://schema.org",
  "@type": "FAQPage",
  "mainEntity": [
    {
      "@type": "Question",
      "name": "What KP index do I need to see aurora?",
      "acceptedAnswer": {
        "@type": "Answer",
        "text": "Required KP depends on your magnetic latitude (MLAT). Tromsø needs KP 2-3, Reykjavik needs KP 3-4, while Seattle requires KP 6-7+."
      }
    },
    {
      "@type": "Question",
      "name": "How accurate is the KP forecast?",
      "acceptedAnswer": {
        "@type": "Answer",
        "text": "1-3 hours ahead: very accurate (±0.5 KP). 24-48 hours: moderate accuracy. Week ahead: approximate estimates. Solar flares can increase KP within hours."
      }
    },
    {
      "@type": "Question",
      "name": "Why can't I see aurora despite high KP?",
      "acceptedAnswer": {
        "@type": "Answer",
        "text": "Main reasons: cloud cover (blocks view), full moon (bright light interference), daylight hours (summer in far north), light pollution. Our forecast includes ALL these factors, not just KP."
      }
    }
  ]
})}></script>

<!-- Real-time status sync for Kp value -->
<script src="/scripts/aurora-sync.js?v=3" defer></script>
