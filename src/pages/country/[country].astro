---
import CountryPageLayout from '../../layouts/CountryPageLayout.astro';
import StoreBadges from '../../components/StoreBadges.astro';
import SocialLinks from '../../components/SocialLinks.astro';
import RelatedLinks from '../../components/RelatedLinks.astro';
import CitySearch from '../../components/CitySearch.astro';
import '../../styles/components/city-search.css';
import citiesData from '../../data/site-cities';
import { loadGlobalCityStatuses } from '../../utils/global-status.ts';
import { calculateKpThreshold, calculateKpBands } from '../../utils/kp-bands.ts';
import { sortCitiesByStatusAndMagLat, getSortingExplanation } from '../../utils/city-sorting.ts';
import {
  getCountryBestTimeLinks,
  getCountryLiveLinks
} from '../../utils/cross-links.ts';
import type { CountryPageRecord } from '../../utils/cross-links.ts';
import { appendBrand } from '../../utils/geo-utils.ts';
import { generateCountryTitle } from '../../utils/seo-titles.ts';
import { REGIONS, normalizeStateSlug } from '../../utils/slug-normalizer.ts';
import { getStateFlagUrl, hasStateFlags } from '../../utils/state-flags.ts';

// Generate static paths for all countries in our cities data
export async function getStaticPaths() {
  // Group cities by country
  const countriesMap = new Map();

  citiesData.forEach(city => {
    const countryKey = city.country.toLowerCase().replace(/\s+/g, '-');
    if (!countriesMap.has(countryKey)) {
      countriesMap.set(countryKey, {
        name: city.country,
        countryCode: city.countryCode,
        cities: []
      });
    }
    countriesMap.get(countryKey).cities.push(city);
  });

  return Array.from(countriesMap.entries()).map(([slug, countryData]) => ({
    params: { country: slug },
    props: { countryData: { slug, ...countryData } },
  }));
}

const { countryData } = Astro.props;

if (!countryData) {
  throw new Error('Country data is required for country page generation');
}
const { slug, name, countryCode, cities } = countryData;

// Load global city statuses
const globalCityStatuses = await loadGlobalCityStatuses();

// SEO optimization
const canonicalUrl = `https://auroraforecast.uk/country/${slug}`;

// Calculate country statistics
const avgMagneticLat = cities.reduce((sum, city) => sum + (city.magneticLat || 0), 0) / cities.length;
const totalPopulation = cities.reduce((sum, city) => sum + (city.population || 0), 0);
// Calculate best (lowest) Kp threshold from cities with highest magnetic latitude
const bestKpThreshold = Math.min(...cities.map(city => calculateKpThreshold(city.magneticLat)));

// Sort cities by current aurora status + magnetic latitude (active aurora first)
const sortedCities = sortCitiesByStatusAndMagLat(cities, globalCityStatuses);
const highlightCities = sortedCities.slice(0, 3).map((city) => city.name).join(', ');
const baseTitle = generateCountryTitle(name, cities.length);
const pageTitle = appendBrand(baseTitle);
const pageDescription = `Live aurora status, best months, and travel tips for ${name}'s ${cities.length} key cities including ${highlightCities}.`;

const originSlug = `country/${slug}`;
const countryRecord: CountryPageRecord = {
  slug,
  name,
  countryCode,
  cities: sortedCities
};
const countryLiveLinks = getCountryLiveLinks(countryRecord, 3);
const countryGuideLinks = getCountryBestTimeLinks(countryRecord, 3);
const highlightCity = sortedCities[0];

// Filter regions for this country
const countryISO = countryCode.toLowerCase();
const countryRegions = Object.entries(REGIONS)
  .filter(([_, region]) => region.country === countryISO)
  .map(([slug, region]) => {
    const regionCities = cities.filter(city => {
      const stateSlug = city.state?.toLowerCase().replace(/\s+/g, '-');
      return region.states.includes(stateSlug);
    });
    return {
      slug,
      name: region.name,
      cityCount: regionCities.length
    };
  })
  .filter(r => r.cityCount > 0);

// Aggregate states for this country
const stateMap = new Map();
cities.forEach(city => {
  if (city.state) {
    const normalizedSlug = normalizeStateSlug(city.state, countryCode);
    if (!stateMap.has(normalizedSlug)) {
      stateMap.set(normalizedSlug, {
        name: city.state,
        count: 0,
        slug: normalizedSlug
      });
    }
    stateMap.get(normalizedSlug).count++;
  }
});
const availableStates = Array.from(stateMap.values()).sort((a, b) => a.name.localeCompare(b.name));

// Breadcrumb structure for country page
const breadcrumbs = [
  { title: 'Home', href: '/' },
  { title: name } // Current page - no href
];
---

<CountryPageLayout
  title={pageTitle}
  description={pageDescription}
  canonical={canonicalUrl}
  countryData={countryData}
  breadcrumbs={breadcrumbs}
>
  <!-- Header Content -->
  <h1 slot="header-content">Aurora forecast & viewing guide for {name}</h1>
  <p class="intro" slot="header-content">
    Explore our aurora forecast map, live status grid, and trip planning tips for {name}. Track visibility, best months, and travel advice across {cities.length} major locations.
    {highlightCity && (
      <>
        {' '}
        <a
          class="cross-link-inline"
          href={`/best-time/${highlightCity.slug}`}
          data-cross-link
          data-slot="intro"
          data-type="guide"
          data-target={`best-time/${highlightCity.slug}`}
          data-position="1"
        >
          Plan for {highlightCity.name} ‚Üí
        </a>
      </>
    )}
  </p>

  <!-- Stats -->
  <div class="stat" slot="stats">
    <h3>Cities Covered</h3>
    <p>{cities.length}</p>
  </div>
  <div class="stat" slot="stats">
    <h3>Avg Magnetic Latitude</h3>
    <p>{avgMagneticLat.toFixed(1)}¬∞</p>
  </div>
  <div class="stat" slot="stats">
    <h3>Best Kp Threshold</h3>
    <p>{bestKpThreshold.toFixed(1)}+</p>
  </div>

  <!-- Cities Gallery -->
  <section class="country-cities-gallery" slot="cities-gallery">
    <h2>Aurora Destinations in {name}</h2>
    <div class="city-search-wrapper">
      <CitySearch id="country-city-search" compact={true} />
    </div>
    <div class="country-cities-grid">
      {sortedCities.slice(0, 16).map((city) => {
        const cityStatus = globalCityStatuses[city.slug] || {
          status: 'unknown',
          statusText: 'Check forecast',
          color: '#666666'
        };
        const bands = calculateKpBands(city.magneticLat);

        return (
          <a href={`/${city.slug}`} class={`city-card status-${cityStatus.status}`} data-city-slug={city.slug}>
            <div class="city-card-content">
              <div class="city-header">
                <h3>{city.name}</h3>
                <div class="city-meta">
                  <span class="meta-item">
                    <span class="meta-label">MLAT</span>
                    <span class="meta-value">{city.magneticLat?.toFixed(1) || 'N/A'}¬∞</span>
                  </span>
                  <span class="meta-item">
                    <span class="meta-label">Min Kp</span>
                    <span class="meta-value">{bands.horizon.toFixed(1)}+</span>
                  </span>
                </div>
              </div>
              <p class="city-description">{city.description}</p>
              <div class="city-status-info">
                <div class="city-status-text-group">
                  <div class="city-status-text">Current Status</div>
                  <div class="city-status-label" data-status-label>{cityStatus.statusText}</div>
                </div>
                <div class="city-view-btn">View Forecast</div>
              </div>
            </div>
          </a>
        );
      })}
    </div>
    {sortedCities.length > 16 && (
      <div class="more-cities-info">
        <p>Showing top 16 {getSortingExplanation(Object.keys(globalCityStatuses).length > 0)}. {name} has {sortedCities.length} total aurora viewing locations.</p>
        <details class="all-cities-list">
          <summary>View all {sortedCities.length} cities</summary>
          <div class="all-cities-links">
            {sortedCities.slice(16).map(city => (
              <a href={`/${city.slug}`} class="city-link">{city.name}</a>
            ))}
          </div>
        </details>
      </div>
    )}
  </section>

  <!-- Live Links -->
  <RelatedLinks
    slot="live-links"
    title={`Live aurora status across ${name}`}
    links={countryLiveLinks}
    originSlug={originSlug}
  />

  <!-- Guide Section -->
  <section class="country-guide" slot="guide">
    <h2>Aurora Viewing Guide for {name}</h2>
    <div class="guide-grid">
      <div class="guide-card">
        <h3>Geographic Advantages</h3>
        <ul>
          <li>Average magnetic latitude: {avgMagneticLat.toFixed(1)}¬∞ (optimal aurora zone)</li>
          <li>Total coverage: {cities.length} prime viewing locations</li>
          <li>Population centers: {totalPopulation.toLocaleString()} total residents</li>
          <li>Light pollution: {cities.filter(c => c.population < 100000).length} low-pollution sites</li>
        </ul>
      </div>

      <div class="guide-card">
        <h3>Best Viewing Season</h3>
        <ul>
          <li>Peak months: September through March</li>
          <li>Optimal Kp threshold: {bestKpThreshold.toFixed(1)}+ geomagnetic activity</li>
          <li>Dark sky window: {name === 'Iceland' || name === 'Norway' ? '4-6 months' : '6-8 months'}</li>
          <li>Weather considerations: Check cloud forecasts before travel</li>
        </ul>
      </div>

      <div class="guide-card">
        <h3>How to Use Our App</h3>
        <ul>
          <li>Real-time visibility forecasts for each city</li>
          <li>Push notifications for aurora activity</li>
          <li>Cloud coverage and moon phase data</li>
          <li>Extended 72-hour forecasts (Premium)</li>
        </ul>
      </div>
    </div>
  </section>

  <!-- Regions Section -->
  {availableStates.length > 0 && (
    <section class="country-regions" slot="regions">
      <h2>States & Regions in {name}</h2>
      <p class="regions-intro">Explore multi-state aurora viewing regions with comprehensive coverage across {name}.</p>

      <div class="state-search-wrapper">
        <div class="state-search-container">
          <span class="search-icon">üîç</span>
          <input
            type="text"
            id="state-search"
            placeholder="Search states..."
            class="state-search-input"
          />
        </div>
      </div>

      <div class="regions-grid" id="states-grid">
        {availableStates.map(state => {
          const flagUrl = getStateFlagUrl(state.slug, countryCode);
          return (
            <a href={`/${countryISO}/${state.slug}`} class="region-card" data-name={(state.name || '').toLowerCase()}>
              {flagUrl && (
                <img src={flagUrl} alt={`${state.name} flag`} class="region-flag" loading="lazy" />
              )}
              <div class="region-info">
                <h3>{state.name}</h3>
                <span class="region-coverage">{state.count} locations</span>
              </div>
              <div class="region-arrow">‚Üí</div>
            </a>
          );
        })}
      </div>
    </section>
  )}

  <!-- Best Time Links -->
  <RelatedLinks
    slot="best-time-links"
    title={`Plan your ${name} aurora trip`}
    links={countryGuideLinks}
    originSlug={originSlug}
  />

  <!-- Structured Data -->
  <script
    slot="structured-data"
    type="application/ld+json"
    set:html={JSON.stringify({
      "@context": "https://schema.org",
      "@type": "CollectionPage",
      "name": `Northern Lights ${name}`,
      "description": pageDescription,
      "url": canonicalUrl,
      "mainEntity": {
        "@type": "Country",
        "name": name,
        "geo": {
          "@type": "GeoCoordinates",
          "latitude": avgMagneticLat,
          "longitude": cities.reduce((sum, city) => sum + (city.lon || 0), 0) / cities.length
        }
      },
      "hasPart": sortedCities
        .filter(city => typeof city.lat === 'number' && typeof city.lon === 'number')
        .map(city => ({
          "@type": "Place",
          "name": city.name,
          "url": `https://auroraforecast.uk/${city.slug}`,
          "geo": {
            "@type": "GeoCoordinates",
            "latitude": city.lat,
            "longitude": city.lon
          }
        }))
    })}
  ></script>

  <script
    slot="structured-data"
    type="application/ld+json"
    set:html={JSON.stringify({
      '@context': 'https://schema.org',
      '@type': 'BreadcrumbList',
      itemListElement: breadcrumbs.map((b, i) => ({
        '@type': 'ListItem',
        position: i + 1,
        name: b.title,
        item: b.href ? `https://auroraforecast.uk${b.href}` : `https://auroraforecast.uk/country/${slug}`
      }))
    })}
  ></script>

  <!-- Social Links -->
  <SocialLinks slot="social-links" position="footer" />

  <!-- Page Navigation -->
  <nav class="page-nav" slot="page-nav">
    <a href="/">‚Üê All Aurora Locations</a>
    <a href={`/${sortedCities[0]?.slug}`}>Live Forecast ‚Üí</a>
  </nav>

  <!-- Sticky Footer -->
  <StoreBadges slot="sticky-footer" pageType="country_hub" countryCode={countryCode} placement="sticky_footer" sticky={true} enhanced={true} />
</CountryPageLayout>

<script type="module" src="/scripts/cross-link-tracker.js"></script>
<script type="module" src="/src/scripts/state-search.js"></script>
<script src="/scripts/aurora-sync.js?v=3" defer></script>
<div data-origin-slug={originSlug} style="display:none;"></div>
